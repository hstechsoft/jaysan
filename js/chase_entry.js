
var urlParams = new URLSearchParams(window.location.search);
var phone_id = urlParams.get('phone_id');
var current_user_id = localStorage.getItem("ls_uid");
var current_user_name = localStorage.getItem("ls_uname");
var physical_stock_array = [];
$(document).ready(function () {
    var details = '';




    $("#menu_bar").load('menu.html',
        function () {
            var lo = (window.location.pathname.split("/").pop());
            var web_addr = "#" + (lo.substring(0, lo.indexOf(".")))


            if ($(web_addr).find("a").hasClass('nav-link')) {
                $(web_addr).find("a").toggleClass('active')
            }
            else if ($(web_addr).find("a").hasClass('dropdown-item')) {
                $(web_addr).parent().parent().find("a").eq(0).toggleClass('active')
            }


        }
    );



    check_login();

    $("#unamed").text(localStorage.getItem("ls_uname"))
    get_assign_order();

    // $("#printInvoice").on("click", function (event) {
    //     event.preventDefault();
    //     // TODO: handle click here

    //     const win = window.open("storage%2Fpdf%2Finvoice1001.pdf", "_blank");
    //     // Some browsers need a delay before printing
    //     const printTimer = setInterval(() => {
    //         if (win.document.readyState === "complete") {
    //             clearInterval(printTimer);
    //             win.focus();
    //             win.print();
    //         }
    //     }, 500);
    // });
    // $("#print").on("click", function (event) {
    //     event.preventDefault();
    //     // TODO: handle click here
    //     var invoiceHtml = $("#invoicePreview").prop("outerHTML");

    //     // Encode it to protect HTML structure in POST
    //     var encodedHtml = encodeURIComponent(invoiceHtml);
    //     $.ajax({
    //         url: "pdf_handler.php",
    //         method: "POST",
    //         data: {
    //             save_path: "storage/pdf/invoice1001",
    //             file_name: "Invoice.pdf",
    //             unique_file: "no",
    //             header_html: "<h3>HS Tech Soft - Invoice</h3>",
    //             footer_html: "<p>Generated by HS Tech Soft ERP</p>",
    //             body_html: encodedHtml,
    //             orientation: "portrait",
    //             paper_size: "A4",
    //             stream: "no",
    //             // email_to: "nklharish1@gmail.com",
    //             // email_subject: "Invoice #1001",
    //             // email_body: "Hello, please find attached your invoice.",
    //             // pdf_password: "",        // optional
    //             // watermark_text: ""       // optional
    //         },
    //         success: function (res) {
    //             console.log(res);
    //             if (res.download_url) {
    //                 // 3Ô∏è‚É£ open PDF and trigger browser print dialog
    //                 const win = window.open(res.download_url, "_blank");
    //                 // Some browsers need a delay before printing
    //                 const printTimer = setInterval(() => {
    //                     if (win.document.readyState === "complete") {
    //                         clearInterval(printTimer);
    //                         win.focus();
    //                         win.print();
    //                     }
    //                 }, 500);
    //             } else {
    //                 alert("PDF generated, but no download URL returned");
    //             }
    //         },
    //         error: function (xhr) {
    //             alert("Error: " + xhr.responseText);
    //         }
    //     });
    // });



    

    $("#sale_order").on("change", function () {

        $("#chase_entry_table").addClass("d-none");
        // $("#chase_entry_table").empty();

        $("#chase_entry_preview_btn").removeClass('d-none')
        $("#chase_entry_btn").addClass('d-none')

        const encodedDetails = $(this).find("option:selected").data("details");
        if (encodedDetails) {

            details = JSON.parse(decodeURIComponent(encodedDetails));
            console.log("‚úÖ Details loaded:", details);
        } else {
            console.warn("‚ö†Ô∏è No details found in selected option");
            details = null;
        }
    });

    $("#chase_entry_preview_btn").on("click", function () {
        if (
            $("#sale_order").val() !== null &&
            $("#chase_no").val() !== "" &&
            $("#prepared_by").val() !== "" &&
            $("#department").val() !== ""
        ) {
            $("#chase_entry_table").removeClass("d-none");

            const chase = $("#chase_no").val();
            const prepare = $("#prepared_by").val();
            const department = $("#department").val();

            $("#chase_no_val").text(chase);
            $("#prepared_by_val").html("Prepared By: <strong>" + prepare + "</strong>");
            $("#department_val").html("Department: <strong>" + department + "</strong>");

            if (details !== null) {
                var mcd = details.commitment_date.trim().split(" ");
                $("#model").text(details.model || "");
                $("#type").text(details.type || "");
                $("#sub_type").text(details.sub_type || "");
                $("#mcd").text(mcd[0] || "");
                // $("#pcd").text(details.sale_order_date || "");
                $("#transport_type").text(details.loading_type || "");
                $("#ins_note").text(details.color_choice || "" + " " + details.any_other_spec || "" + " " + details.any_other_spec || "" + " " + details.color_choice_des || "");


                const qrData = details.ass_id;

                // Clear old QR code
                document.getElementById("qrcode").innerHTML = "";

                // Generate new QR code
                new QRCode(document.getElementById("qrcode"), {
                    text: qrData,
                    width: 100,
                    height: 100,
                });


            } else {
                salert("Error", "No details found for selected sale order", "error");
            }

            $(this).addClass('d-none')
            $("#chase_entry_btn").removeClass('d-none')

        } else {
            salert("Error", "Please fill all required fields", "error");
        }
    });

    // $("#chase_entry_btn").on("click", function () {
    //     setTimeout(() => {
    //         window.print();
    //     }, 500);
    // })
    $("#chase_entry_btn").on("click", function (event) {
            event.preventDefault();
            // TODO: handle click here
            var invoiceHtml = $("#chase_entry_table").prop("outerHTML");

            // Encode it to protect HTML structure in POST
            var encodedHtml = encodeURIComponent(invoiceHtml);
            $.ajax({
                url: "pdf_handler.php",
                method: "POST",
                data: {
                    save_path: "storage/pdf/jobcard",
                    file_name: "jobcard.pdf",
                    unique_file: "no",
                    header_html: "<h3>HS Tech Soft - Job Card</h3>",
                    footer_html: "<p>Generated by HS Tech Soft ERP</p>",
                    body_html: encodedHtml,
                    orientation: "portrait",
                    paper_size: "A4",
                    stream: "no",
                    // email_to: "nklharish1@gmail.com",
                    // email_subject: "Invoice #1001",
                    // email_body: "Hello, please find attached your invoice.",
                    // pdf_password: "",        // optional
                    // watermark_text: ""       // optional
                },
                success: function (res) {
                    console.log(res);
                    if (res.download_url) {
                        // 3Ô∏è‚É£ open PDF and trigger browser print dialog
                        const win = window.open(res.download_url, "_blank");
                        // Some browsers need a delay before printing
                        const printTimer = setInterval(() => {
                            if (win.document.readyState === "complete") {
                                clearInterval(printTimer);
                                win.focus();
                                win.print();
                            }
                        }, 500);
                    } else {
                        alert("PDF generated, but no download URL returned");
                    }
                },
                error: function (xhr) {
                    alert("Error: " + xhr.responseText);
                }
            });
        });


    });


    function get_assign_order() {

        $.ajax({
            url: "php/get_assign_order.php",
            type: "get", //send it through get method
            data: {

            },
            success: function (response) {
                // console.log(response);



                if (response.trim() != 'error') {

                    var obj = JSON.parse(response);
                    $("#sale_order").empty();
                    $("#sale_order").append("<option value='null' disabled selected>Select Sale Order</option>")


                    obj.forEach(function (obj) {
                        let label = obj.cus_name + " - " + obj.product + " - " + obj.sub_type +" - " + obj.order_no ;
                        if (obj.order_type === "Emergency") {
                            label += " üö®"; // add emoji instead of icon
                        }
                        $("#sale_order").append("<option data-details='" + encodeURIComponent(JSON.stringify(obj)) + "'>" + label + "</option>")
                    });

                }





            },
            error: function (xhr) {
                //Do Something to handle error
            }
        });




    }




    function insert_new_process(processId) {

        $.ajax({
            url: "php/insert_nprocess.php",
            type: "get", //send it through get method
            data: {

                process_id: processId,
                edit_process_id: edit_process_id,
                input_part_id: sel_input_part_id,
                output_part_id: sel_output_part_id,
            },
            success: function (response) {
                console.log(response);



                if (response.trim()) {
                    sessionStorage.setItem('editProcessId', response.trim());
                    sessionStorage.setItem('breadcrumb', $('#out_breadcrumb').html());
                    // Reload the page
                    location.reload();
                }





            },
            error: function (xhr) {
                //Do Something to handle error
            }
        });




    }













    function check_login() {

        if (localStorage.getItem("logemail") == null && phone_id == null) {
            window.location.replace("login.html");
        }
        else if (localStorage.getItem("logemail") == null && phone_id != null) {
            get_current_userid_byphoneid();
            $('#menu_bar').hide()
        }

        else {

        }
    }


    function get_current_userid_byphoneid() {
        $.ajax({
            url: "php/get_current_employee_id_byphoneid.php",
            type: "get", //send it through get method
            data: {
                phone_id: phone_id,


            },
            success: function (response) {


                if (response.trim() != "error") {
                    var obj = JSON.parse(response);


                    console.log(response);


                    obj.forEach(function (obj) {
                        current_user_id = obj.emp_id;
                        current_user_name = obj.emp_name;
                    });

                    //    get_sales_order()
                }

                else {
                    salert("Error", "User ", "error");
                }



            },
            error: function (xhr) {
                //Do Something to handle error
            }
        });
    }


    function shw_toast(title, des, theme) {


        $('.toast-title').text(title);
        $('.toast-description').text(des);
        var toast = new bootstrap.Toast($('#myToast'));
        toast.show();
    }

    function get_millis(t) {

        var dt = new Date(t);
        return dt.getTime();
    }



    function get_cur_millis() {
        var dt = new Date();
        return dt.getTime();
    }


    function get_today_date() {
        var date = new Date();

        var day = date.getDate();
        var month = date.getMonth() + 1;
        var year = date.getFullYear();

        var hour = date.getHours();
        var mins = date.getMinutes();

        console.log(mins)

        if (month < 10) month = "0" + month;
        if (day < 10) day = "0" + day;

        var today = year + "-" + month + "-" + day + "T" + hour + ":" + mins;
        return today;
    }

    function get_today_start_millis() {
        var date = new Date();

        var day = date.getDate();
        var month = date.getMonth() + 1;
        var year = date.getFullYear();

        if (month < 10) month = "0" + month;
        if (day < 10) day = "0" + day;

        var today = year + "-" + month + "-" + day + "T00:00";

        return get_millis(today)

    }


    function get_today_end_millis() {
        var date = new Date();

        var day = date.getDate();
        var month = date.getMonth() + 1;
        var year = date.getFullYear();

        if (month < 10) month = "0" + month;
        if (day < 10) day = "0" + day;

        var today = year + "-" + month + "-" + day + "T23:59";

        return get_millis(today)

    }

    function salert(title, text, icon) {


        swal({
            title: title,
            text: text,
            icon: icon,
        });
    }



    function millis_to_date(millis) {
        var d = new Date(millis); // Parameter should be long value


        return d.toLocaleString('en-GB');

    }